<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Detection Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>🚨 Clash Detection Dashboard</h1>
                    <p class="subtitle">Real-time monitoring with append-only data system</p>
                </div>
                <div class="header-right">
                    <div class="data-info">
                        <span id="dataStats" class="data-stats">Loading...</span>
                    </div>
                    <div class="filter-container">
                        <select id="dateFilter" onchange="filterByDate(this.value)" title="Filter data by date range">
                            <option value="all">📅 All Time</option>
                            <option value="30days">📅 Last 30 Days</option>
                            <option value="90days">📅 Last 90 Days</option>
                            <option value="1year">📅 Last Year</option>
                        </select>
                    </div>
                    <button class="export-btn" onclick="dashboard.showExportOptions()" title="Export data">📥 Export</button>
                    <div class="last-updated">
                        Last updated: <span id="lastUpdated">Loading...</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">🌙</button>
                    <button class="refresh-btn" onclick="loadData()" title="Refresh data">🔄 Refresh</button>
                </div>
            </div>
        </header>

        <!-- System Status Banner -->
        <div id="systemStatus" class="system-status hidden">
            <div class="status-content">
                <span id="statusIcon">🔄</span>
                <span id="statusText">System operational - append-only data sync active</span>
                <button onclick="this.parentElement.parentElement.style.display='none'">×</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <section class="summary-section">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="card-icon">📊</div>
                    <div class="card-content">
                        <h3>Total Clashes</h3>
                        <div class="card-value" id="totalClashes">0</div>
                        <div class="card-trend" id="clashTrend"></div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">❌</div>
                    <div class="card-content">
                        <h3>X Button Clicks</h3>
                        <div class="card-value" id="totalXClicks">0</div>
                        <div class="card-trend" id="xclickTrend"></div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">👥</div>
                    <div class="card-content">
                        <h3>Active Users</h3>
                        <div class="card-value" id="uniqueUsers">0</div>
                        <div class="card-trend" id="userTrend"></div>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="card-icon">🏗️</div>
                    <div class="card-content">
                        <h3>Projects</h3>
                        <div class="card-value" id="uniqueProjects">0</div>
                        <div class="card-trend" id="projectTrend"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Growth Notice -->
        <div id="dataGrowthNotice" class="performance-notice hidden">
            <div class="notice-content">
                📈 Large dataset detected: <span id="eventCount">0</span> events across <span id="dayCount">0</span> days. 
                Charts optimized for performance.
                <button onclick="this.parentElement.parentElement.style.display='none'">×</button>
            </div>
        </div>

        <!-- Charts Section -->
        <section class="charts-section">
            <div class="charts-grid">
                <!-- Daily Activity Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>📈 Daily Activity Trend</h3>
                        <p>Clash detection and X-click trends (last 100 days for performance)</p>
                    </div>
                    <canvas id="dailyActivityChart"></canvas>
                </div>

                <!-- User Activity Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>👥 Top User Activity</h3>
                        <p>Most active users (top 20)</p>
                    </div>
                    <canvas id="userActivityChart"></canvas>
                </div>

                <!-- Project Progression Chart -->
                <div class="chart-container" style="grid-column: 1 / -1;"> <!-- Full width -->
                    <div class="chart-header">
                        <h3>📊 Project Progression Over Time</h3>
                        <p>Track cumulative clash trends for each project</p>
                        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                            <select id="progressionProjectSelect" onchange="dashboard.updateProgressionChart(this.value)" 
                                    style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
                                <option value="all">All Projects</option>
                            </select>
                            
                            <select id="progressionTimeScale" onchange="dashboard.updateTimeScale(this.value)"
                                    style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                    <canvas id="projectProgressionChart"></canvas>
                </div>
                
                <!-- Add Project Metrics Cards -->
                <div class="summary-section" style="padding-top: 0;">
                    <h3 style="margin-bottom: 1rem;">📈 Project Trends (Last 30 Days)</h3>
                    <div class="summary-grid" id="projectTrendsGrid">
                        <!-- Project trend cards will be inserted here -->
                    </div>
                </div>

                <!-- Project Distribution Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>🏗️ Project Distribution</h3>
                        <p>Clashes by project (top 10)</p>
                    </div>
                    <canvas id="projectChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Data Tables Section -->
        <section class="tables-section">
            <div class="tables-grid">
                <!-- Recent Activity -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>🕒 Recent Activity</h3>
                        <p>Latest clash detection events (continuously appended)</p>
                        <div class="pagination-info">
                            <!-- Pagination info will be inserted here -->
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table id="recentActivityTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Project</th>
                                    <th>Element Info</th>             
                                    <th>Clashing With</th>              
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-pagination">
                        <!-- Pagination controls will be inserted here -->
                    </div>
                </div>
                <!-- Project Details Section -->
<section class="project-details-section" style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
    <div class="table-container">
        <div class="table-header" style="background: linear-gradient(135deg, #2563eb, #10b981);">
            <h3 style="color: white;">🏗️ Project Clash Details</h3>
            <p style="color: rgba(255,255,255,0.9);">Select a project to view all its clash events</p>
            
            <!-- Project Selector -->
            <div style="margin-top: 1rem;">
                <select id="projectSelector" onchange="dashboard.loadProjectDetails(this.value)" 
                        style="padding: 0.75rem; font-size: 1rem; width: 100%; max-width: 400px; 
                               border-radius: 8px; border: 2px solid white;">
                    <option value="">-- Select a Project --</option>
                </select>
            </div>
        </div>
        
                <!-- Project Statistics -->
                <div id="projectStats" style="display: none; padding: 1.5rem; background: var(--background-color);">
                    <div class="summary-grid" style="margin-bottom: 1.5rem;">
                        <div class="summary-card" style="padding: 1rem;">
                            <div class="card-icon">🚨</div>
                            <div class="card-content">
                                <h3>Total Clashes</h3>
                                <div class="card-value" id="projectTotalClashes">0</div>
                            </div>
                        </div>
                        <div class="summary-card" style="padding: 1rem;">
                            <div class="card-icon">❌</div>
                            <div class="card-content">
                                <h3>X-Clicks</h3>
                                <div class="card-value" id="projectTotalXClicks">0</div>
                            </div>
                        </div>
                        <div class="summary-card" style="padding: 1rem;">
                            <div class="card-icon">👤</div>
                            <div class="card-content">
                                <h3>Active Users</h3>
                                <div class="card-value" id="projectActiveUsers">0</div>
                            </div>
                        </div>
                        <div class="summary-card" style="padding: 1rem;">
                            <div class="card-icon">📅</div>
                            <div class="card-content">
                                <h3>Last Activity</h3>
                                <div class="card-value" id="projectLastActivity" style="font-size: 0.9rem;">N/A</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Statistics -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>👤 User Statistics</h3>
                        <p>Cumulative activity summary</p>
                    </div>
                    <div class="table-wrapper">
                        <table id="userStatsTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Clashes</th>
                                    <th>X-Clicks</th>
                                    <th>Most Active Project</th>
                                    <th>Last Activity</th>
                                </tr>
                            </thead>
                            <tbody id="userStatsBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                    <div class="table-container">
                <div class="table-header">
                    <h3>📋 Project Statistics</h3>
                    <p>Cumulative project clash summary</p>
                </div>
                <div class="table-wrapper">
                    <table id="projectStatsTable">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Total Clashes</th>
                                <th>X-Clicks</th>
                                <th>Active Users</th>
                                <th>Last Clash</th>
                            </tr>
                        </thead>
                        <tbody id="projectStatsBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

        <!-- Project Clashes Table -->
                <div id="projectClashesContainer" style="display: none;">
                    <div class="table-wrapper">
                        <table id="projectClashesTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Element Info</th>
                                    <th>Clashing With</th>
                                </tr>
                            </thead>
                            <tbody id="projectClashesBody">
                                <!-- Project clashes will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- No Project Selected Message -->
                <div id="noProjectSelected" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <p style="font-size: 1.2rem;">📊 Select a project from the dropdown above to view its clash details</p>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-content">
                <p>&copy; 2024 Clash Detection Dashboard | JBB BIM EHAB AHMAD</p>
                <p>🔄 Append-Only Data System | GitHub Pages | 
                   <span id="footerStats">Continuous data accumulation enabled</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading clash detection data...</p>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚠️ Error Loading Data</h3>
                <span class="close" onclick="closeErrorModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="errorMessage">Unable to load dashboard data. Please try again later.</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeErrorModal()">Close</button>
                <button onclick="loadData()">Retry</button>
            </div>
        </div>
    </div>

    <!-- Data Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📊 Data Statistics</h3>
                <span class="close" onclick="this.closest('.modal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div id="statsContent">
                    <!-- Statistics content will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="this.closest('.modal').style.display='none'">Close</button>
                <button onclick="dashboard.showExportOptions()">Export Data</button>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js"></script>
</body>
</html>
